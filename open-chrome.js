const { Builder, By, until } = require('selenium-webdriver');
const chrome = require('selenium-webdriver/chrome');

// ‚úÖ ƒêƒÉng nh·∫≠p v√† tr·∫£ v·ªÅ driver
async function loginToWebsite(email, password) {
  const driver = await new Builder().forBrowser('chrome').setChromeOptions(new chrome.Options()).build();

  try {
    await driver.manage().window().maximize();
    await driver.get('https://cms.gmv.vn/admin/sessions/create');
    const emailInput = await driver.wait(until.elementLocated(By.name('email')), 10000);
    await emailInput.sendKeys(email);

    const passwordInput = await driver.wait(until.elementLocated(By.name('password')), 10000);
    await passwordInput.sendKeys(password);

    const loginButton = await driver.wait(until.elementLocated(By.xpath("//button[.//span[text()='ƒêƒÉng nh·∫≠p']]")), 10000);
    await loginButton.click();

    console.log('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng.');
    await driver.sleep(1000);
    return driver;
  } catch (err) {
    console.error('‚ùå L·ªói ƒëƒÉng nh·∫≠p:', err);
    await driver.quit();
  }
}

// ‚úÖ Ch·ªçn ƒë∆°n h√†ng theo m√£
async function selectOrder(driver, orderId) {
  try {
    const inputWrapper = await driver.wait(
      until.elementLocated(By.css('.el-input__wrapper')),
      10000
    );
    await inputWrapper.click();

    const inputField = await driver.wait(
      until.elementLocated(By.css('.el-input__inner')),
      10000
    );
    await inputField.clear();
    await inputField.sendKeys(orderId);

    await driver.sleep(2000);

    const matchedItem = await driver.wait(
      until.elementLocated(By.xpath(`//li[contains(@class,'el-select-dropdown__item')]//div[contains(text(), '${orderId}')]`)),
      5000
    );
    await matchedItem.click();
    console.log(`‚úÖ ƒê√£ ch·ªçn ƒë∆°n h√†ng: ${orderId}`);
  } catch (err) {
    console.warn(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng: ${orderId}`);
    
    // // Fallback n·∫øu ch∆∞a ph·∫£i l√† fallback r·ªìi
    // if (true) {
    //   console.log('üîÅ ƒêang fallback v·ªõi orderId: 210924GAXP');
    //   await selectOrder(driver, '210924GAXP');
    // } else {
    //   console.error(`‚ùå Fallback th·∫•t b·∫°i: Kh√¥ng t√¨m ƒë∆∞·ª£c ƒë∆°n h√†ng n√†o ph√π h·ª£p.`);
    // }
  }
}


// ‚úÖ ƒêi·ªÅn th·ªùi gian b·∫Øt ƒë·∫ßu / k·∫øt th√∫c
async function fillStartEndTime(driver, startTime, endTime) {
  try {
    const startInput = await driver.wait(until.elementLocated(By.xpath("//input[@placeholder='Ch·ªçn th·ªùi gian b·∫Øt ƒë·∫ßu ']")), 10000);
    await startInput.click();
    await startInput.clear();
    await startInput.sendKeys(startTime);
    console.log(`‚úÖ B·∫Øt ƒë·∫ßu: ${startTime}`);
    const noteArea = await driver.wait(until.elementLocated(By.xpath("//textarea[@placeholder='Note phi√™n live']")), 10000);
    await noteArea.click();
    const endInput = await driver.wait(until.elementLocated(By.xpath("//input[@placeholder='Ch·ªçn th·ªùi gian k·∫øt th√∫c ']")), 10000);
    await endInput.click();
    await endInput.clear();
    await endInput.sendKeys(endTime);
    console.log(`‚úÖ K·∫øt th√∫c: ${endTime}`);
  } catch (err) {
    console.error('‚ùå L·ªói th·ªùi gian:', err);
  }
}

// ‚úÖ ƒêi·ªÅn ghi ch√∫
async function fillNote(driver, assistant, orderId, mainHost, roomName) {
  try {
    const noteArea = await driver.wait(until.elementLocated(By.xpath("//textarea[@placeholder='Note phi√™n live']")), 10000);
    await noteArea.clear();
    await noteArea.sendKeys('ƒê∆°n h√†ng : ');
    await noteArea.sendKeys(orderId);
    await noteArea.sendKeys(` Live ch√≠nh: ' ${mainHost}  Ph√≤ng live : `);
    await noteArea.sendKeys(' Tr·ª£ Live :');
    await noteArea.sendKeys(assistant);
    await noteArea.sendKeys(' Ph√≤ng : ');
    await noteArea.sendKeys(roomName);
    console.log(`‚úÖ Ghi ch√∫: ${note + sessionList}`);
  } catch (err) {
    console.error('‚ùå L·ªói ghi ch√∫:', err);
  }
}

// ‚úÖ Ch·ªçn hub live
async function fillHublive(driver) {
  try {
    const wrapper = await driver.wait(
      until.elementLocated(By.xpath("//input[@placeholder='Ch·ªçn Hublive']/ancestor::div[contains(@class,'el-input__wrapper')]")),
      10000
    );
    await wrapper.click();
    await driver.sleep(1000);

    const hubOption = await driver.wait(
      until.elementLocated(By.xpath("//li[contains(@class, 'el-select-dropdown__item')]//span[contains(text(), 'Hub H√† N·ªôi')]")),
      10000
    );
    await hubOption.click();
    console.log(`‚úÖ ƒê√£ ch·ªçn Hub H√† N·ªôi`);
  } catch (err) {
    console.error('‚ùå L·ªói ch·ªçn hub live:', err);
  }
}

// ‚úÖ Ch·ªçn ph·ª• live (assistant)
async function selectAssistant(driver, assistant) {
  try {
    const wrapper = await driver.wait(
      until.elementLocated(By.xpath("//input[@placeholder='Ch·ªçn ph·ª• live']/ancestor::div[contains(@class, 'el-input__wrapper')]")),
      10000
    );
    await wrapper.click();

    const dynamicInput = await driver.wait(until.elementLocated(By.css("input.el-select__input")), 5000);
    await dynamicInput.sendKeys(assistant);

    await driver.sleep(1000);

    const email = 'tvdtazan112@gmail.com';

const emailDiv = await driver.wait(
  until.elementLocated(
    By.xpath(`//div[@class='description' and text()='${email}']`)
  ),
  10000
);

await driver.executeScript("arguments[0].scrollIntoView(true);", emailDiv); // ƒë·∫£m b·∫£o th·∫•y ƒë∆∞·ª£c
await emailDiv.click();

console.log(`‚úÖ ƒê√£ click v√†o email: ${email}`);



    console.log(`‚úÖ ƒê√£ ch·ªçn tr·ª£ live: ${assistant}`);
  } catch (err) {
    console.error('‚ùå L·ªói ch·ªçn tr·ª£ live:', err);
  }
}

// ‚úÖ Ch·ªçn main host
async function selectMainHost(driver, mainHost) {
  try {
    const normalize = str => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();

    const searchInput = await driver.wait(
      until.elementLocated(By.xpath("//input[@placeholder='T√¨m ki·∫øm streamer']")),
      5000
    );

    await searchInput.click();
    await searchInput.clear();
    await searchInput.sendKeys(mainHost);
     await driver.sleep(1000);
    await searchInput.sendKeys(' ');

    // ƒê·ª£i ph·∫ßn t·ª≠ xu·∫•t hi·ªán
    await driver.sleep(2000);

    // Ch·ªù cho c√°c streamer ƒë∆∞·ª£c render (√≠t nh·∫•t 1 item c√≥ class c·ª• th·ªÉ)
    await driver.wait(
      until.elementLocated(By.css(".py-3.px-4.flex.gap-2.cursor-pointer")),
      5000
    );

    const hostCards = await driver.findElements(By.css(".py-3.px-4.flex.gap-2.cursor-pointer"));

    for (const card of hostCards) {
      const nameElement = await card.findElement(By.css("h5.text-sm.font-semibold"));
      const nameText = await nameElement.getText();

      if (normalize(nameText).includes(normalize(mainHost))) {
        await driver.executeScript("arguments[0].scrollIntoView(true);", card);
        await card.click();
        console.log(`‚úÖ ƒê√£ ch·ªçn host kh·ªõp: ${nameText}`);
        return;
      }
    }

    console.warn("‚ùå Kh√¥ng t√¨m th·∫•y host kh·ªõp.");
  } catch (err) {
    console.error(`‚ùå L·ªói khi ch·ªçn main host '${mainHost}':`, err);
  }
}




// ‚úÖ Ch·ªçn ph√≤ng live, th·ª≠ fallback n·∫øu kh√¥ng ch·ªçn ƒë∆∞·ª£c ph√≤ng mong mu·ªën
async function clickLiveRoom(driver, preferredRoom) {
  const fallbackRooms = [
    'Ph√≤ng live 1', 'Ph√≤ng live 2', 'Ph√≤ng live 3', 'Ph√≤ng live 4',
    'Ph√≤ng live 5', 'Ph√≤ng live 6', 'Ph√≤ng live 13', 'Ph√≤ng live 14',
    'Ph√≤ng mega 1', 'Ph√≤ng mega 3', 'Ph√≤ng Vip 1', 'Ph√≤ng 30',
    'Ph√≤ng Tr√† C≈©', 'Ph√≤ng H·ª£p 2'
  ];

  // T·∫°o danh s√°ch th·ª≠: ph√≤ng mong mu·ªën tr∆∞·ªõc, sau ƒë√≥ l√† c√°c fallback
  const roomList = [preferredRoom, ...fallbackRooms.filter(r => r !== preferredRoom)];

  for (const roomName of roomList) {
    try {
      const success = await driver.executeScript(`
        const roomName = arguments[0];
        const labels = document.querySelectorAll('label.el-radio');

        for (let label of labels) {
          if (label.textContent.trim().includes(roomName)) {
            const input = label.querySelector('input[type="radio"]');
            if (input) {
              input.click();
              input.dispatchEvent(new Event('change', { bubbles: true }));
              return true;
            }
          }
        }
        return false;
      `, roomName);

      if (success) {
        console.log(`‚úÖ ƒê√£ ch·ªçn ph√≤ng: ${roomName}`);
        return roomName;
      } else {
        console.warn(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ho·∫∑c kh√¥ng click ƒë∆∞·ª£c: ${roomName}`);
      }
    } catch (err) {
      console.error(`‚ùå L·ªói khi ch·ªçn ph√≤ng '${roomName}':`, err);
    }
  }

  throw new Error('‚ùå Kh√¥ng click ƒë∆∞·ª£c b·∫•t k·ª≥ ph√≤ng n√†o trong danh s√°ch!');
}


// ‚úÖ Click n√∫t "T·∫°o phi√™n"
async function clickCreate(driver) {
  try {
    const createButton = await driver.wait(
      until.elementLocated(By.xpath("//button[.//span[text()='T·∫°o phi√™n']]")),
      10000
    );
    await driver.executeScript("arguments[0].scrollIntoView(true);", createButton);
    await driver.sleep(500); // ƒë·ª£i scroll
    await createButton.click();
    console.log("‚úÖ ƒê√£ click n√∫t 'T·∫°o phi√™n'");
  } catch (err) {
    console.error("‚ùå L·ªói khi click n√∫t 'T·∫°o phi√™n':", err);
  }
}





// ‚úÖ G·ªôp t·∫°o session
async function createSession(driver, session) {
  const { orderId, startTime, endTime, note, mainHost, assistant, roomName } = session;
  await selectOrder(driver, orderId);
  await fillStartEndTime(driver, startTime, endTime);
  await fillNote(driver,  assistant,orderId, mainHost, roomName);
  await selectAssistant(driver, assistant);

  await fillHublive(driver);
  await selectMainHost(driver, mainHost);
  await clickLiveRoom(driver, roomName);
 // await clickCreate(driver);
}

// ‚úÖ M·ªói phi√™n trong tab m·ªõi
async function createSessionInNewTab(driver, session) {
  try {
    await driver.executeScript("window.open('about:blank', '_blank');");
    const handles = await driver.getAllWindowHandles();
    const newTab = handles[handles.length - 1];
    await driver.switchTo().window(newTab);
    await driver.get('https://cms.gmv.vn/admin/sessions/create');

    await createSession(driver, session);
  } catch (err) {
    console.error('‚ùå L·ªói t·∫°o phi√™n ·ªü tab m·ªõi:', err);
  }
}

// ‚úÖ Danh s√°ch phi√™n c·∫ßn t·∫°o


const sessionList = [
  { orderId: '080624KPIR', startTime: '21:00 31/07/2025', endTime: '23:00 31/07/2025', note: '', mainHost: 'Ng·ªçc Anh', assistant: 'Tiktok', roomName: 'P KT c≈©' },
  { orderId: '100625CPMZ', startTime: '08:00 31/07/2025', endTime: '10:00 31/07/2025', note: '', mainHost: 'H√≤a', assistant: '', roomName: 'Ph√≤ng live 5' },
  { orderId: '100625CPMZ', startTime: '12:00 31/07/2025', endTime: '14:00 31/07/2025', note: '', mainHost: 'H√≤a', assistant: '', roomName: '' },
  { orderId: '130625AFNP', startTime: '09:00 31/07/2025', endTime: '11:00 31/07/2025', note: '', mainHost: 'Ma H√†', assistant: 'Tiktok', roomName: '' },
  { orderId: '130625AFNP', startTime: '20:00 31/07/2025', endTime: '22:00 31/07/2025', note: '', mainHost: 'Ma H√†', assistant: '', roomName: 'Ph√≤ng live 3' },
  { orderId: '100725DCVZ', startTime: '15:00 31/07/2025', endTime: '17:00 31/07/2025', note: 'L·∫•y th√™m s√≤ m√°t m√°y', mainHost: 'Hi·ªÅn', assistant: 'Tiktok', roomName: '' },
  { orderId: '100725DCVZ', startTime: '17:00 31/07/2025', endTime: '19:00 31/07/2025', note: 'L·∫•y th√™m s√≤ m√°t m√°y', mainHost: 'Trinh', assistant: '', roomName: 'Ph√≤ng live 7' },
  { orderId: '100725DCVZ', startTime: '19:00 31/07/2025', endTime: '21:00 31/07/2025', note: 'L·∫•y th√™m s√≤ m√°t m√°y', mainHost: 'H·∫£i', assistant: '', roomName: '' },
  { orderId: '100725DCVZ', startTime: '21:00 31/07/2025', endTime: '23:00 31/07/2025', note: 'L·∫•y th√™m s√≤ m√°t m√°y', mainHost: 'Th∆°m', assistant: '', roomName: '' },
  { orderId: '270525REAX', startTime: '09:00 31/07/2025', endTime: '11:00 31/07/2025', note: 'm√°y 26 live ƒë√∫ng m√°y', mainHost: 'Nhung', assistant: 'Tiktok', roomName: '' },
  { orderId: '270525REAX', startTime: '11:30 31/07/2025', endTime: '13:30 31/07/2025', note: 'm√°y 26 live ƒë√∫ng m√°y', mainHost: 'Duy√™n', assistant: '', roomName: 'Ph√≤ng live 4' },
  { orderId: '270525REAX', startTime: '20:00 31/07/2025', endTime: '22:00 31/07/2025', note: 'm√°y 3', mainHost: 'Th·∫£o', assistant: '', roomName: '' },
  { orderId: '130625JEZQ', startTime: '19:00 31/07/2025', endTime: '21:00 31/07/2025', note: 'T3, T5, T7, CN', mainHost: 'Lan Anh', assistant: 'Tiktok', roomName: 'Ph√≤ng live 9' },
  { orderId: 'Femfresh', startTime: '10:30 31/07/2025', endTime: '12:30 31/07/2025', note: '', mainHost: 'Hi·ªÅn', assistant: 'Tiktok', roomName: 'Ph√≤ng live 8' },
  { orderId: 'Batiste', startTime: '18:00 31/07/2025', endTime: '20:00 31/07/2025', note: '', mainHost: 'Th∆°m', assistant: 'Tiktok', roomName: 'Ph√≤ng live 8' },
  { orderId: 'Trangia', startTime: '20:30 31/07/2025', endTime: '22:30 31/07/2025', note: 'Oxiclean-->60%, aff', mainHost: 'Duy√™n', assistant: 'Tiktok', roomName: 'Ph√≤ng live 8' },
  { orderId: 'Aimi', startTime: '20:00 31/07/2025', endTime: '22:00 31/07/2025', note: '', mainHost: 'TƒÉng H√†', assistant: 'Tiktok', roomName: 'Ph√≤ng live 3' },
  { orderId: 'LINGROUP', startTime: '11:30 31/07/2025', endTime: '13:30 31/07/2025', note: '', mainHost: 'Trinh', assistant: 'Tiktok', roomName: 'Ph√≤ng live 9' },
  { orderId: 'Ru m∆°', startTime: '11:30 31/07/2025', endTime: '13:30 31/07/2025', note: '', mainHost: 'Nhung', assistant: 'Tiktok', roomName: 'Ph√≤ng live 6' },
  { orderId: 'Monnyny', startTime: '', endTime: '', note: 'b√°o nh√£n ƒë·ªïi gi·ªù', mainHost: '', assistant: 'Tiktok', roomName: 'Ph√≤ng live 5' },
  { orderId: 'Monnyny', startTime: '17:30 31/07/2025', endTime: '19:30 31/07/2025', note: '', mainHost: 'Th·∫£o', assistant: 'Tiktok', roomName: '' },
  { orderId: 'Thuka Garden', startTime: '11:00 31/07/2025', endTime: '13:00 31/07/2025', note: '', mainHost: 'H·∫£i', assistant: 'Tiktok', roomName: 'Ph√≤ng live 5' },
  { orderId: 'Thuka Garden', startTime: '20:00 31/07/2025', endTime: '22:00 31/07/2025', note: '', mainHost: 'Trinh', assistant: 'Tiktok', roomName: '' }
];


// ‚úÖ G·ªçi h√†m ch√≠nh
(async () => {
  const driver = await loginToWebsite('hoangboytq@gmail.com', 'MxRKPGFhKj@5BXZ');
  if (driver) {
    for (const session of sessionList) {
      await createSessionInNewTab(driver, session);
      await driver.sleep(1000);
    }
    console.log('üéâ T·∫°o xong to√†n b·ªô phi√™n.');
  }
})();
